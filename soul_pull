#!/bin/bash

echo "ðŸ”® Starting Soul Pull Ritual..."

# Move into the correct directory
cd "$(dirname "$0")" || exit 1

echo "ðŸ“¦ Loading environment variables from .env..."
export $(grep -v '^#' .env | xargs)

if [ -z "$SPOTIPY_REDIRECT_URI" ]; then
  echo "âš ï¸  SPOTIPY_REDIRECT_URI not set in .env. Aborting."
  exit 1
fi

# Copy redirect URI to clipboard (macOS only)
echo -n "$SPOTIPY_REDIRECT_URI" | pbcopy
echo "ðŸ“‹ Copied redirect URI to clipboard:"
echo "   $SPOTIPY_REDIRECT_URI"

# Open Spotify Dev Dashboard for manual update
echo "ðŸŒ Opening Spotify Developer Dashboard..."
open "https://developer.spotify.com/dashboard/applications"

echo ""
echo "ðŸ› ï¸  Paste the URI above into your Spotify app's redirect URIs."
read -p "ðŸ” Press [Enter] once you've updated the Spotify redirect URI..."

echo "ðŸ§¿ Step 1: Starting Flask server on port 8889..."
FLASK_APP=server.py flask run --port=8889 > /dev/null &
FLASK_PID=$!
sleep 2

echo "ðŸŒ Step 2: Opening free ngrok tunnel..."
ngrok http 8889 > /dev/null &
NGROK_PID=$!
sleep 3

echo ""
echo "âœ¨ Your OAuth URL: Check your ngrok URL here:"
echo "   http://127.0.0.1:4040"
echo ""
echo "ðŸ§˜ Waiting for Spotify login... (press CTRL+C to kill everything manually)"
echo ""

trap 'echo "ðŸ’€ Killing tunnel and Flask..."; kill $FLASK_PID $NGROK_PID; exit' INT
while true; do sleep 1; done

